# EMI Payment Data Flow Diagram

## ğŸ”„ Complete Flow: When Admin Marks EMI as Paid

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADMIN MARKS EMI AS PAID                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Admin clicks "Mark Paid" button for specific EMI      â”‚
â”‚  â€¢ Opens modal with EMI details                                 â”‚
â”‚  â€¢ Shows month, due date, amount                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Admin enters paid date and confirms                   â”‚
â”‚  â€¢ Input: Paid date (e.g., 2025-11-24)                         â”‚
â”‚  â€¢ Can also change status if needed                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Validation Check                                       â”‚
â”‚  â“ Is this EMI already processed by ECS system?               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                         â”‚
                    â”‚ YES                     â”‚ NO
                    â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âŒ STOP           â”‚    â”‚ âœ… CONTINUE              â”‚
        â”‚ Show error:       â”‚    â”‚ Proceed with update      â”‚
        â”‚ "Cannot override  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  ECS payment"     â”‚                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Fetch Current EMI Status                              â”‚
â”‚  ğŸ“Š Query: product_emi_statuses                                â”‚
â”‚  â€¢ Get current status (e.g., "Pending")                         â”‚
â”‚  â€¢ Get current paid_date (if any)                               â”‚
â”‚  â€¢ Get current payment_method                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Update EMI Status Record                              â”‚
â”‚  ğŸ’¾ UPDATE product_emi_statuses                                â”‚
â”‚  SET:                                                            â”‚
â”‚    â€¢ status = 'Paid'                                            â”‚
â”‚    â€¢ payment_method = 'manual'                                  â”‚
â”‚    â€¢ paid_date = '2025-11-24'                                   â”‚
â”‚    â€¢ paid_by_user_id = 'admin-user-id'                         â”‚
â”‚    â€¢ updated_at = NOW()                                         â”‚
â”‚  WHERE:                                                          â”‚
â”‚    â€¢ product_loan_id = 'loan-id'                               â”‚
â”‚    â€¢ installment_index = 1                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Create Audit Trail Record                             â”‚
â”‚  ğŸ“ INSERT INTO product_emi_payment_audit                      â”‚
â”‚  VALUES:                                                         â”‚
â”‚    â€¢ product_loan_id = 'loan-id'                               â”‚
â”‚    â€¢ installment_index = 1                                      â”‚
â”‚    â€¢ old_status = 'Pending'                                     â”‚
â”‚    â€¢ new_status = 'Paid'                                        â”‚
â”‚    â€¢ paid_date = '2025-11-24'                                   â”‚
â”‚    â€¢ payment_method = 'manual'                                  â”‚
â”‚    â€¢ changed_by = 'admin-user-id'                              â”‚
â”‚    â€¢ changed_at = NOW()                                         â”‚
â”‚    â€¢ notes = 'Marked as Paid on 24/11/2025 by Admin Name'     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: Fetch Current Loan Paid Amount                        â”‚
â”‚  ğŸ“Š Query: product_loans                                       â”‚
â”‚  â€¢ Get current paid_amount (e.g., â‚¹20,864)                     â”‚
â”‚  â€¢ Calculate new amount: â‚¹20,864 + â‚¹20,864 = â‚¹41,728          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: Update Loan Total Paid Amount                         â”‚
â”‚  ğŸ’¾ UPDATE product_loans                                       â”‚
â”‚  SET:                                                            â”‚
â”‚    â€¢ paid_amount = â‚¹41,728                                      â”‚
â”‚    â€¢ last_payment_date = '2025-11-24'                          â”‚
â”‚    â€¢ payment_updated_at = NOW()                                 â”‚
â”‚  WHERE:                                                          â”‚
â”‚    â€¢ id = 'loan-id'                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 9: Recalculate Loan Payment Status                       â”‚
â”‚  ğŸ“Š Query: Count all EMI statuses                              â”‚
â”‚  â€¢ Count 'Paid' EMIs: 1                                         â”‚
â”‚  â€¢ Count 'ECS Success' EMIs: 1                                  â”‚
â”‚  â€¢ Count 'ECS Bounce' EMIs: 0                                   â”‚
â”‚  â€¢ Count 'Due Missed' EMIs: 0                                   â”‚
â”‚  â€¢ Total Completed: 2 / 12                                      â”‚
â”‚                                                                  â”‚
â”‚  Determine Status:                                               â”‚
â”‚  â€¢ If has bounces â†’ 'bounce'                                    â”‚
â”‚  â€¢ Else if has missed â†’ 'overdue'                              â”‚
â”‚  â€¢ Else if all paid â†’ 'paid'                                   â”‚
â”‚  â€¢ Else â†’ 'ontrack' âœ…                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 10: Update Loan Payment Status                           â”‚
â”‚  ğŸ’¾ UPDATE product_loans                                       â”‚
â”‚  SET:                                                            â”‚
â”‚    â€¢ payment_status = 'ontrack'                                 â”‚
â”‚    â€¢ payment_updated_at = NOW()                                 â”‚
â”‚  WHERE:                                                          â”‚
â”‚    â€¢ id = 'loan-id'                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 11: Trigger Real-time Sync                               â”‚
â”‚  ğŸ“¡ Supabase Real-time Broadcast                               â”‚
â”‚  â€¢ Notifies all connected clients                               â”‚
â”‚  â€¢ Other admins see update instantly                            â”‚
â”‚  â€¢ Customer dashboard updates automatically                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 12: Update UI State                                      â”‚
â”‚  ğŸ¨ Frontend State Update                                      â”‚
â”‚  â€¢ Update rows state with new status                            â”‚
â”‚  â€¢ Update paid date in UI                                       â”‚
â”‚  â€¢ Update payment method badge                                  â”‚
â”‚  â€¢ Refresh EMI progress bar                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 13: Show Success Message                                 â”‚
â”‚  âœ… Success Alert                                              â”‚
â”‚  "EMI Status Updated Successfully!"                             â”‚
â”‚  â€¢ Month: Jan                                                   â”‚
â”‚  â€¢ New Status: Paid                                             â”‚
â”‚  â€¢ Paid Date: 24/11/2025                                        â”‚
â”‚  â€¢ Amount: â‚¹20,864                                              â”‚
â”‚  â€¢ Loan Status: ONTRACK                                         â”‚
â”‚  â€¢ Total Paid: â‚¹41,728                                          â”‚
â”‚  â€¢ Payments Completed: 2/12                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   END   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Database Tables Updated (Summary)

| Table | Action | Fields Updated |
|-------|--------|----------------|
| **product_emi_statuses** | UPDATE | status, payment_method, paid_date, paid_by_user_id, updated_at |
| **product_emi_payment_audit** | INSERT | All fields (new audit record) |
| **product_loans** | UPDATE | paid_amount, last_payment_date, payment_updated_at, payment_status |

---

## ğŸ” Data Before vs After

### BEFORE (EMI Status):
```json
{
  "product_loan_id": "aa2d7fb6-1b15-4ebb-8456-4cdaf1b49009",
  "installment_index": 1,
  "status": "Pending",
  "payment_method": "pending",
  "paid_date": null,
  "paid_by_user_id": null
}
```

### AFTER (EMI Status):
```json
{
  "product_loan_id": "aa2d7fb6-1b15-4ebb-8456-4cdaf1b49009",
  "installment_index": 1,
  "status": "Paid",
  "payment_method": "manual",
  "paid_date": "2025-11-24",
  "paid_by_user_id": "admin-user-id"
}
```

### NEW AUDIT RECORD:
```json
{
  "product_loan_id": "aa2d7fb6-1b15-4ebb-8456-4cdaf1b49009",
  "installment_index": 1,
  "old_status": "Pending",
  "new_status": "Paid",
  "paid_date": "2025-11-24",
  "payment_method": "manual",
  "changed_by": "admin-user-id",
  "changed_at": "2025-11-24T10:30:00Z",
  "notes": "Marked as Paid on 24/11/2025 by Admin Name"
}
```

### LOAN TOTALS UPDATED:
```json
// BEFORE
{
  "paid_amount": 20864,
  "payment_status": "ontrack",
  "last_payment_date": "2025-12-12"
}

// AFTER
{
  "paid_amount": 41728,  // +20864
  "payment_status": "ontrack",
  "last_payment_date": "2025-11-24"
}
```

---

## ğŸ¯ Key Points

1. **Atomic Transaction**: All updates happen together or none at all
2. **Audit Trail**: Every change is logged with who, when, and what
3. **Real-time Sync**: All connected clients see updates instantly
4. **Validation**: Cannot override ECS-processed payments
5. **Recalculation**: Loan status is recalculated based on all EMI statuses
6. **User Tracking**: System records which admin made the change

---

## ğŸ” Security Checks

- âœ… Only admins can mark EMIs as paid
- âœ… ECS-processed EMIs cannot be manually overridden
- âœ… All changes are audited with user ID
- âœ… Timestamps are recorded for all changes
- âœ… Real-time sync ensures data consistency

---

## ğŸ“ Implementation File

**Location**: `src/components/PaymentDetailsModal.tsx`

**Function**: `handleSavePaidDate()` (Lines 238-536)

This function handles the entire flow shown above.
